// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TrainingLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ELITE
}

enum TrainingGoal {
  STRENGTH
  HYPERTROPHY
  HYBRID
  CONDITIONING
  FAT_LOSS
  LONGEVITY
}

enum Tier {
  SILVER
  GOLD
  BLACK
}

enum SectionType {
  WARMUP
  EMOM
  AMRAP
  FOR_TIME
  FINISHER
  COOLDOWN
  WAVE // For PR1ME: Strength wave sets (10-8-8-8, 6-4-3-2-1, etc.)
  SUPERSET // For FORGE: Push/pull or squat/hinge supersets
  CIRCUIT // For CIRCUIT_X: Multiple AMRAP blocks
  CAPACITY // For CAPAC1TY: Long engine blocks (12-20 min)
  FLOW // For FLOWSTATE: Tempo work, KB flows, slow EMOMs
  INTERVAL // Sprint/interval sessions: work/rest intervals (e.g., 20s work, 100s rest, 6-10 rounds)
  OTHER
}

enum WorkoutArchetype {
  PR1ME
  FORGE
  ENGIN3
  CIRCUIT_X
  CAPAC1TY
  FLOWSTATE
}

enum ProgramCycle {
  BASE
  LOAD
  INTENSIFY
  DELOAD
  PEAK
  RESET
}

enum ExerciseCategory {
  STRENGTH
  MIXED
  SKILL
  ENGINE
  CORE
  MOBILITY
}

enum MovementPattern {
  HORIZONTAL_PUSH
  HORIZONTAL_PULL
  VERTICAL_PUSH
  VERTICAL_PULL
  SQUAT
  HINGE
  LUNGE
  CARRY
  LOC0MOTION
  FULL_BODY
  CORE_ANTI_EXTENSION
  CORE_ROTATION
  CORE_FLEXION
  BREATH_MOBILITY
}

enum SpaceRequirement {
  SPOT
  OPEN_AREA
  LANE_5M
  LANE_10M
  RUN_ROUTE
  MACHINE_FIXED
}

enum ImpactLevel {
  LOW
  MEDIUM
  HIGH
}

enum TypicalUse {
  PRIMARY
  ASSISTANCE
  CONDITIONING
  WARMUP
  FINISHER
  FLOWSTATE
}

enum UserRole {
  SUPERADMIN
  HOME_USER
  COACH
  GYM_OWNER
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  COACH
  GYM
}

model User {
  id               String           @id @default(cuid())
  email            String           @unique
  passwordHash     String
  name             String?
  role             UserRole         @default(HOME_USER)
  isAdmin          Boolean          @default(false) // Legacy - use role instead
  subscriptionTier SubscriptionTier @default(FREE)
  subscriptionEnds DateTime?
  xp               Int              @default(0) // Experience points for gamification
  level             Int              @default(1) // User level (1-100+)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  profile         UserProfile?
  programs        UserProgram[]
  sessions        SessionLog[]
  coachProfile    CoachProfile?
  gymProfile      GymProfile?
  clients         CoachClient[]        @relation("CoachClients")
  assignedBy      CoachClient[]        @relation("AssignedBy")
  gymMemberships  GymMember[]
  classAttendance GymClassAttendance[]

  @@map("users")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  trainingLevel  TrainingLevel
  primaryGoal    TrainingGoal?
  equipment      String[]
  daysPerWeek    Int?
  availableSpace String[] // SPOT, OPEN_AREA, LANE_5M, LANE_10M, RUN_ROUTE
  injuries       String[] // List of injuries/limitations
  limitations    String[] // Movement restrictions
  notes          String?

  @@map("user_profiles")
}

model Program {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique
  description   String?
  level         TrainingLevel?
  goal          TrainingGoal?
  durationWeeks Int?
  isPublic      Boolean        @default(true)
  currentCycle  ProgramCycle?
  createdBy     String? // userId or null for system programs
  coachId       String? // If created by a coach
  coach         CoachProfile?  @relation("CoachPrograms", fields: [coachId], references: [id], onDelete: SetNull)

  workouts     Workout[]
  userPrograms UserProgram[]
  assignments  ProgramAssignment[]
  sessions     SessionLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("programs")
}

model Workout {
  id         String           @id @default(cuid())
  programId  String?
  program    Program?         @relation(fields: [programId], references: [id], onDelete: SetNull)
  templateId String?
  template   WorkoutTemplate? @relation("TemplateWorkouts", fields: [templateId], references: [id], onDelete: SetNull)

  name          String
  displayCode   String?
  dayIndex      Int?
  archetype     WorkoutArchetype?
  description   String? // Archetype-specific description
  shareId       String?           @unique // For shareable workouts
  isRecommended Boolean           @default(false) // Admin-curated recommended workouts

  sections   WorkoutSection[]
  sessions   SessionLog[]
  gymClasses GymClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workouts")
}

model WorkoutSection {
  id        String  @id @default(cuid())
  workoutId String
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  title String
  type  SectionType
  order Int

  durationSec       Int?
  emomWorkSec       Int?
  emomRestSec       Int?
  emomRounds        Int?
  intervalWorkSec   Int? // For INTERVAL: work duration in seconds
  intervalRestSec   Int? // For INTERVAL: rest duration in seconds
  intervalRounds    Int? // For INTERVAL: number of rounds
  rounds            Int? // For FOR_TIME sections with multiple rounds (e.g., "1:40 Cap × 4 Rounds")
  restBetweenRounds Int? // Rest duration in seconds between rounds for FOR_TIME sections

  note String?

  blocks ExerciseBlock[]

  @@map("workout_sections")
}

model ExerciseBlock {
  id        String         @id @default(cuid())
  sectionId String
  section   WorkoutSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  order     Int

  label          String?
  exerciseName   String
  description    String?
  repScheme      String?
  tempo          String? // Tempo notation (e.g., "2220", "2s pause", "3s eccentric")
  loadPercentage String? // Load percentage (e.g., "@ 40-45-50-55%")
  distance       Int?
  distanceUnit   String?

  tierPrescriptions TierPrescription[]

  @@map("exercise_blocks")
}

model TierPrescription {
  id      String        @id @default(cuid())
  blockId String
  block   ExerciseBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  tier         Tier
  load         String?
  targetReps   Int?
  distance     Int? // For erg machines and distance-based exercises: different distance per tier
  distanceUnit String? // "m" for meters, "cal" for calories
  notes        String?

  @@unique([blockId, tier])
  @@map("tier_prescriptions")
}

model UserProgram {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  programId String
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  startDate   DateTime
  currentWeek Int      @default(1)
  isActive    Boolean  @default(true)

  @@map("user_programs")
}

model SessionLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  workoutId String
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationSec Int? // Total duration in seconds
  completed   Boolean   @default(false)

  rpe   Int? // Rate of Perceived Exertion (1-10)
  notes String?

  // Detailed metrics (JSON for flexibility)
  metrics Json? // { weights: {...}, reps: {...}, times: {...}, volume: {...} }

  // Heart rate data (future)
  avgHeartRate Int?
  maxHeartRate Int?

  // Program tracking
  programId String?
  program   Program? @relation(fields: [programId], references: [id], onDelete: SetNull)
  weekIndex Int?
  dayIndex  Int?

  // Gym class tracking
  gymClassAttendance GymClassAttendance?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("session_logs")
}

model Exercise {
  id                 String             @id @default(cuid())
  exerciseId         String             @unique // e.g., "db_bench_press"
  name               String
  aliases            String[]           @default([])
  category           ExerciseCategory
  movementPattern    MovementPattern
  primaryMuscles     String[]           @default([])
  secondaryMuscles   String[]           @default([])
  equipment          String[]           @default([])
  space              SpaceRequirement
  impactLevel        ImpactLevel
  typicalUse         TypicalUse[]
  suitableArchetypes WorkoutArchetype[]
  indoorFriendly     Boolean            @default(true)
  notes              String?

  // New fields for reference/how-to guide
  instructions    String? // Step-by-step instructions on how to perform the exercise
  variations      Json? // Array of exercise variations with descriptions
  graphics        String[] @default([]) // URLs or paths to instructional graphics/icons
  videoUrl        String? // Optional video demonstration URL
  commonMistakes  String[] @default([]) // Common form mistakes to avoid
  progressionTips String? // Tips for progressing the exercise
  regressionTips  String? // Tips for regressing the exercise if too difficult
  aiGenerated     Boolean  @default(false) // Track if exercise was AI-generated
  usageCount      Int      @default(0) // Track how many times this exercise has been used

  tiers ExerciseTier[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("exercises")
}

model ExerciseTier {
  id          String   @id @default(cuid())
  exerciseId  String
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  tier        Tier
  description String?
  typicalReps String?

  @@unique([exerciseId, tier])
  @@map("exercise_tiers")
}

// Coach System
model CoachProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio            String?
  specialties    String[]
  certifications String[]
  website        String?
  instagram      String?

  clients  CoachClient[]
  programs Program[]     @relation("CoachPrograms")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coach_profiles")
}

model CoachClient {
  id       String @id @default(cuid())
  coachId  String
  coach    User   @relation("CoachClients", fields: [coachId], references: [id], onDelete: Cascade)
  clientId String
  client   User   @relation("AssignedBy", fields: [clientId], references: [id], onDelete: Cascade)

  status    String    @default("ACTIVE") // ACTIVE, PAUSED, COMPLETED
  notes     String?
  startDate DateTime  @default(now())
  endDate   DateTime?

  assignments    ProgramAssignment[]
  CoachProfile   CoachProfile?       @relation(fields: [coachProfileId], references: [id])
  coachProfileId String?

  @@unique([coachId, clientId])
  @@map("coach_clients")
}

model ProgramAssignment {
  id            String      @id @default(cuid())
  coachClientId String
  coachClient   CoachClient @relation(fields: [coachClientId], references: [id], onDelete: Cascade)
  programId     String
  program       Program     @relation(fields: [programId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())
  startDate  DateTime
  status     String   @default("ACTIVE") // ACTIVE, COMPLETED, PAUSED

  @@unique([coachClientId, programId])
  @@map("program_assignments")
}

// Gym System
model GymProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  address   String?
  website   String?
  instagram String?
  logo      String?

  members GymMember[]
  classes GymClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gym_profiles")
}

model GymMember {
  id     String     @id @default(cuid())
  gymId  String
  gym    GymProfile @relation(fields: [gymId], references: [id], onDelete: Cascade)
  userId String
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  status   String   @default("ACTIVE") // ACTIVE, INACTIVE
  joinedAt DateTime @default(now())

  @@unique([gymId, userId])
  @@map("gym_members")
}

model GymClass {
  id    String     @id @default(cuid())
  gymId String
  gym   GymProfile @relation(fields: [gymId], references: [id], onDelete: Cascade)

  name        String
  description String?
  workoutId   String?
  workout     Workout? @relation(fields: [workoutId], references: [id], onDelete: SetNull)

  scheduledAt DateTime
  duration    Int? // minutes
  capacity    Int?
  attendees   GymClassAttendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gym_classes")
}

model GymClassAttendance {
  id      String   @id @default(cuid())
  classId String
  class   GymClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  userId  String
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  attended     Boolean     @default(false)
  sessionLogId String?     @unique
  sessionLog   SessionLog? @relation(fields: [sessionLogId], references: [id], onDelete: SetNull)

  @@unique([classId, userId])
  @@map("gym_class_attendance")
}

// Template System for NØDE Archetypes
model WorkoutTemplate {
  id          String           @id @default(cuid())
  name        String
  archetype   WorkoutArchetype
  description String?

  // Template structure definition (JSON)
  structure Json // Defines sections, timing, rules for this archetype

  isPublic  Boolean @default(false)
  createdBy String? // userId or null for system templates

  workouts Workout[] @relation("TemplateWorkouts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workout_templates")
}
