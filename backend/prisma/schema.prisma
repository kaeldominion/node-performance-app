// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum TrainingLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
  ELITE
}

enum TrainingGoal {
  STRENGTH
  HYPERTROPHY
  HYBRID
  CONDITIONING
  FAT_LOSS
  LONGEVITY
}

enum Tier {
  SILVER
  GOLD
  BLACK
}

enum SectionType {
  WARMUP
  EMOM
  E2MOM // Every 2 Minutes On the Minute - 2 minute intervals instead of 1
  AMRAP
  FOR_TIME
  FINISHER
  COOLDOWN
  WAVE // For PR1ME: Strength wave sets (10-8-8-8, 6-4-3-2-1, etc.)
  SUPERSET // For FORGE: Push/pull or squat/hinge supersets
  CIRCUIT // For CIRCUIT_X: Multiple AMRAP blocks
  CAPACITY // For CAPAC1TY: Long engine blocks (12-20 min)
  FLOW // For FLOWSTATE: Tempo work, KB flows, slow EMOMs
  INTERVAL // Sprint/interval sessions: work/rest intervals (e.g., 20s work, 100s rest, 6-10 rounds)
  OTHER
}

enum WorkoutArchetype {
  PR1ME
  FORGE
  ENGIN3
  CIRCUIT_X
  CAPAC1TY
  FLOWSTATE
}

enum ProgramCycle {
  BASE
  LOAD
  INTENSIFY
  DELOAD
  PEAK
  RESET
}

enum ExerciseCategory {
  STRENGTH
  MIXED
  SKILL
  ENGINE
  CORE
  MOBILITY
}

enum MovementPattern {
  HORIZONTAL_PUSH
  HORIZONTAL_PULL
  VERTICAL_PUSH
  VERTICAL_PULL
  SQUAT
  HINGE
  LUNGE
  CARRY
  LOC0MOTION
  FULL_BODY
  CORE_ANTI_EXTENSION
  CORE_ROTATION
  CORE_FLEXION
  BREATH_MOBILITY
}

enum SpaceRequirement {
  SPOT
  OPEN_AREA
  LANE_5M
  LANE_10M
  RUN_ROUTE
  MACHINE_FIXED
}

enum ImpactLevel {
  LOW
  MEDIUM
  HIGH
}

enum TypicalUse {
  PRIMARY
  ASSISTANCE
  CONDITIONING
  WARMUP
  FINISHER
  FLOWSTATE
}

enum UserRole {
  SUPERADMIN
  HOME_USER
  COACH
  GYM_OWNER
}

enum SubscriptionTier {
  FREE
  BASIC
  PREMIUM
  COACH
  GYM
}

model User {
  id               String           @id @default(cuid())
  email            String           @unique
  passwordHash     String
  name             String?
  username         String?          @unique // Username for network connections
  role             UserRole         @default(HOME_USER)
  isAdmin          Boolean          @default(false) // Legacy - use role instead
  subscriptionTier SubscriptionTier @default(FREE)
  subscriptionEnds DateTime?
  xp               Int              @default(0) // Experience points for gamification
  level            Int              @default(1) // User level (1-100+)
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  profile            UserProfile?
  programs           UserProgram[]
  sessions           SessionLog[]
  scheduledWorkouts  ScheduledWorkout[]   @relation("ScheduledWorkouts")
  coachProfile       CoachProfile?
  gymProfile         GymProfile?
  clients            CoachClient[]        @relation("CoachClients")
  assignedBy         CoachClient[]        @relation("AssignedBy")
  gymMemberships     GymMember[]
  classAttendance    GymClassAttendance[]
  networkAsRequester Network[]            @relation("NetworkRequester")
  networkAsAddressee Network[]            @relation("NetworkAddressee")
  networkCode        String?              @unique // QR code for adding to network
  notifications      Notification[]
  activityLogs       ActivityLog[]
  createdWorkouts    Workout[]            @relation("CreatedWorkouts")
  achievements       UserAchievement[]
  workoutRatings     WorkoutRating[]
  favoriteWorkouts   WorkoutFavorite[]

  @@map("users")
}

model UserProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Profile picture (from Clerk or custom upload)
  imageUrl String?

  // Physical stats
  weight   Float? // in kg
  height   Float? // in cm
  location String? // City, Country, etc.
  bio      String? // About me / bio

  // Training info
  trainingLevel  TrainingLevel
  primaryGoal    TrainingGoal?
  equipment      String[]
  daysPerWeek    Int?
  availableSpace String[] // SPOT, OPEN_AREA, LANE_5M, LANE_10M, RUN_ROUTE
  injuries       String[] // List of injuries/limitations
  limitations    String[] // Movement restrictions
  notes          String?

  @@map("user_profiles")
}

model Program {
  id            String         @id @default(cuid())
  name          String
  slug          String         @unique
  description   String?
  level         TrainingLevel?
  goal          TrainingGoal?
  durationWeeks Int?
  isPublic      Boolean        @default(true)
  currentCycle  ProgramCycle?
  createdBy     String? // userId or null for system programs
  coachId       String? // If created by a coach
  coach         CoachProfile?  @relation("CoachPrograms", fields: [coachId], references: [id], onDelete: SetNull)

  workouts          Workout[]
  userPrograms      UserProgram[]
  assignments       ProgramAssignment[]
  sessions          SessionLog[]
  scheduledWorkouts ScheduledWorkout[]  @relation("ScheduledPrograms")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("programs")
}

model Workout {
  id         String           @id @default(cuid())
  programId  String?
  program    Program?         @relation(fields: [programId], references: [id], onDelete: SetNull)
  templateId String?
  template   WorkoutTemplate? @relation("TemplateWorkouts", fields: [templateId], references: [id], onDelete: SetNull)
  createdBy  String? // userId who created/saved this workout
  creator    User?            @relation("CreatedWorkouts", fields: [createdBy], references: [id], onDelete: SetNull)

  name          String
  displayCode   String?
  dayIndex      Int?
  archetype     WorkoutArchetype?
  description   String? // Archetype-specific description
  shareId       String?           @unique // For shareable workouts
  isRecommended Boolean           @default(false) // Admin-curated recommended workouts

  sections          WorkoutSection[]
  sessions          SessionLog[]
  gymClasses        GymClass[]
  scheduledWorkouts ScheduledWorkout[] @relation("ScheduledWorkouts")
  ratings           WorkoutRating[]
  favorites         WorkoutFavorite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workouts")
}

model WorkoutSection {
  id        String  @id @default(cuid())
  workoutId String
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  title String
  type  SectionType
  order Int

  durationSec       Int?
  emomWorkSec       Int?
  emomRestSec       Int?
  emomRounds        Int?
  intervalWorkSec   Int? // For INTERVAL: work duration in seconds
  intervalRestSec   Int? // For INTERVAL: rest duration in seconds
  intervalRounds    Int? // For INTERVAL: number of rounds
  rounds            Int? // For FOR_TIME sections with multiple rounds (e.g., "1:40 Cap × 4 Rounds")
  restBetweenRounds Int? // Rest duration in seconds between rounds for FOR_TIME sections

  note String?

  blocks ExerciseBlock[]

  @@map("workout_sections")
}

model ExerciseBlock {
  id        String         @id @default(cuid())
  sectionId String
  section   WorkoutSection @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  order     Int

  label            String?
  exerciseName     String
  description      String? // Legacy field - use shortDescription and longDescription instead
  shortDescription String? // Brief description (max 80 characters) for card display
  longDescription  String? // Full detailed description for popup
  repScheme        String?
  tempo            String? // Tempo notation (e.g., "2220", "2s pause", "3s eccentric")
  loadPercentage   String? // Load percentage (e.g., "@ 40-45-50-55%")
  distance         Int?
  distanceUnit     String?

  tierPrescriptions TierPrescription[]

  @@map("exercise_blocks")
}

model TierPrescription {
  id      String        @id @default(cuid())
  blockId String
  block   ExerciseBlock @relation(fields: [blockId], references: [id], onDelete: Cascade)

  tier         Tier
  load         String?
  targetReps   Int?
  distance     Int? // For erg machines and distance-based exercises: different distance per tier
  distanceUnit String? // "m" for meters, "cal" for calories
  notes        String?

  @@unique([blockId, tier])
  @@map("tier_prescriptions")
}

model UserProgram {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  programId String
  program   Program @relation(fields: [programId], references: [id], onDelete: Cascade)

  startDate   DateTime
  currentWeek Int      @default(1)
  isActive    Boolean  @default(true)

  @@map("user_programs")
}

model ScheduledWorkout {
  id     String @id @default(cuid())
  userId String
  user   User   @relation("ScheduledWorkouts", fields: [userId], references: [id], onDelete: Cascade)

  workoutId String?
  workout   Workout? @relation("ScheduledWorkouts", fields: [workoutId], references: [id], onDelete: Cascade)

  programId String?
  program   Program? @relation("ScheduledPrograms", fields: [programId], references: [id], onDelete: Cascade)

  scheduledDate DateTime // Date and time for the workout
  duration      Int? // Expected duration in minutes
  notes         String?

  order       Int     @default(0) // For ordering on the same day
  isCompleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId, scheduledDate])
  @@map("scheduled_workouts")
}

model SessionLog {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  workoutId String
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  startedAt   DateTime  @default(now())
  completedAt DateTime?
  durationSec Int? // Total duration in seconds
  completed   Boolean   @default(false)

  rpe   Int? // Rate of Perceived Exertion (1-10)
  notes String?

  // Detailed metrics (JSON for flexibility)
  metrics Json? // { weights: {...}, reps: {...}, times: {...}, volume: {...} }

  // Heart rate data (future)
  avgHeartRate Int?
  maxHeartRate Int?

  // Program tracking
  programId String?
  program   Program? @relation(fields: [programId], references: [id], onDelete: SetNull)
  weekIndex Int?
  dayIndex  Int?

  // Gym class tracking
  gymClassAttendance GymClassAttendance?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ratings WorkoutRating[]

  @@map("session_logs")
}

model WorkoutRating {
  id           String      @id @default(cuid())
  sessionLogId String?     @unique
  sessionLog   SessionLog? @relation(fields: [sessionLogId], references: [id], onDelete: Cascade)
  userId       String
  user         User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId    String
  workout      Workout     @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  starRating          Int // 1-5 stars
  difficultyRating    Int? // 1-10
  enjoymentRating     Int? // 1-10
  effectivenessRating Int? // 1-10
  wouldDoAgain        Boolean?
  tags                String[] @default([]) // e.g., "Too Easy", "Perfect", "Too Hard", "Loved It"
  notes               String?
  favoriteExercises   String[] @default([]) // Exercise names that were favorites

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, workoutId, sessionLogId])
  @@index([workoutId])
  @@index([userId])
  @@map("workout_ratings")
}

model WorkoutFavorite {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  workoutId String
  workout   Workout @relation(fields: [workoutId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, workoutId])
  @@index([userId])
  @@index([workoutId])
  @@map("workout_favorites")
}

model Exercise {
  id                 String             @id @default(cuid())
  exerciseId         String             @unique // e.g., "db_bench_press"
  name               String
  aliases            String[]           @default([])
  category           ExerciseCategory
  movementPattern    MovementPattern
  primaryMuscles     String[]           @default([])
  secondaryMuscles   String[]           @default([])
  equipment          String[]           @default([])
  space              SpaceRequirement
  impactLevel        ImpactLevel
  typicalUse         TypicalUse[]
  suitableArchetypes WorkoutArchetype[]
  indoorFriendly     Boolean            @default(true)
  notes              String?

  // New fields for reference/how-to guide
  instructions    String? // Step-by-step instructions on how to perform the exercise
  variations      Json? // Array of exercise variations with descriptions
  graphics        String[] @default([]) // URLs or paths to instructional graphics/icons
  videoUrl        String? // Optional video demonstration URL
  commonMistakes  String[] @default([]) // Common form mistakes to avoid
  progressionTips String? // Tips for progressing the exercise
  regressionTips  String? // Tips for regressing the exercise if too difficult
  aiGenerated     Boolean  @default(false) // Track if exercise was AI-generated
  usageCount      Int      @default(0) // Track how many times this exercise has been used

  // Exercise variations and nuances
  weightRanges        Json? // Weight ranges by tier: {silver: "12-16kg", gold: "20-24kg", black: "28-32kg"}
  durationRanges      Json? // Duration ranges for time-based exercises: {silver: "30-45s", gold: "45-60s", black: "60-90s"}
  intensityLevels     Json? // Intensity variations: {silver: "Low-Moderate", gold: "Moderate-High", black: "High-Max"}
  repRanges           Json? // Rep ranges by tier: {silver: "8-12", gold: "12-15", black: "15-20"}
  tempoOptions        Json? // Tempo variations: ["2020", "2220", "2s pause", "3s eccentric"]
  equipmentVariations Json? // Equipment variations: ["Dumbbells", "Kettlebells", "Barbell", "Bodyweight"]
  movementVariations  Json? // Movement variations: ["Standard", "Pause", "Tempo", "Explosive"]

  // AI-generated image
  imageUrl         String? // URL to AI-generated brutalist style image of the exercise
  imageGeneratedAt DateTime? // When the image was generated

  tiers ExerciseTier[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("exercises")
}

model ExerciseTier {
  id          String   @id @default(cuid())
  exerciseId  String
  exercise    Exercise @relation(fields: [exerciseId], references: [id], onDelete: Cascade)
  tier        Tier
  description String?
  typicalReps String?

  @@unique([exerciseId, tier])
  @@map("exercise_tiers")
}

// Coach System
model CoachProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  bio            String?
  specialties    String[]
  certifications String[]
  website        String?
  instagram      String?

  clients  CoachClient[]
  programs Program[]     @relation("CoachPrograms")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("coach_profiles")
}

model CoachClient {
  id       String @id @default(cuid())
  coachId  String
  coach    User   @relation("CoachClients", fields: [coachId], references: [id], onDelete: Cascade)
  clientId String
  client   User   @relation("AssignedBy", fields: [clientId], references: [id], onDelete: Cascade)

  status    String    @default("ACTIVE") // ACTIVE, PAUSED, COMPLETED
  notes     String?
  startDate DateTime  @default(now())
  endDate   DateTime?

  assignments    ProgramAssignment[]
  CoachProfile   CoachProfile?       @relation(fields: [coachProfileId], references: [id])
  coachProfileId String?

  @@unique([coachId, clientId])
  @@map("coach_clients")
}

model ProgramAssignment {
  id            String      @id @default(cuid())
  coachClientId String
  coachClient   CoachClient @relation(fields: [coachClientId], references: [id], onDelete: Cascade)
  programId     String
  program       Program     @relation(fields: [programId], references: [id], onDelete: Cascade)

  assignedAt DateTime @default(now())
  startDate  DateTime
  status     String   @default("ACTIVE") // ACTIVE, COMPLETED, PAUSED

  @@unique([coachClientId, programId])
  @@map("program_assignments")
}

// Gym System
model GymProfile {
  id     String @id @default(cuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  name      String
  address   String?
  website   String?
  instagram String?
  logo      String?

  members GymMember[]
  classes GymClass[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gym_profiles")
}

model GymMember {
  id     String     @id @default(cuid())
  gymId  String
  gym    GymProfile @relation(fields: [gymId], references: [id], onDelete: Cascade)
  userId String
  user   User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  status   String   @default("ACTIVE") // ACTIVE, INACTIVE
  joinedAt DateTime @default(now())

  @@unique([gymId, userId])
  @@map("gym_members")
}

model GymClass {
  id    String     @id @default(cuid())
  gymId String
  gym   GymProfile @relation(fields: [gymId], references: [id], onDelete: Cascade)

  name        String
  description String?
  workoutId   String?
  workout     Workout? @relation(fields: [workoutId], references: [id], onDelete: SetNull)

  scheduledAt DateTime
  duration    Int? // minutes
  capacity    Int?
  attendees   GymClassAttendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("gym_classes")
}

model GymClassAttendance {
  id      String   @id @default(cuid())
  classId String
  class   GymClass @relation(fields: [classId], references: [id], onDelete: Cascade)
  userId  String
  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  attended     Boolean     @default(false)
  sessionLogId String?     @unique
  sessionLog   SessionLog? @relation(fields: [sessionLogId], references: [id], onDelete: SetNull)

  @@unique([classId, userId])
  @@map("gym_class_attendance")
}

// Template System for NØDE Archetypes
model WorkoutTemplate {
  id          String           @id @default(cuid())
  name        String
  archetype   WorkoutArchetype
  description String?

  // Template structure definition (JSON)
  structure Json // Defines sections, timing, rules for this archetype

  isPublic  Boolean @default(false)
  createdBy String? // userId or null for system templates

  workouts Workout[] @relation("TemplateWorkouts")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("workout_templates")
}

model Network {
  id          String        @id @default(cuid())
  requesterId String
  requester   User          @relation("NetworkRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  addresseeId String
  addressee   User          @relation("NetworkAddressee", fields: [addresseeId], references: [id], onDelete: Cascade)
  status      NetworkStatus @default(PENDING) // PENDING, ACCEPTED, BLOCKED
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([requesterId, addresseeId])
  @@map("network")
}

enum NetworkStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

enum NotificationType {
  NETWORK_REQUEST
  NETWORK_ACCEPTED
  NETWORK_REJECTED
  FRIEND_WORKOUT_STARTED
  FRIEND_WORKOUT_COMPLETED
  FRIEND_WORKOUT_CREATED
  FRIEND_STATS_IMPROVED
  FRIEND_LEVEL_UP
  FRIEND_LEADERBOARD_ENTRY
}

model Notification {
  id            String           @id @default(cuid())
  userId        String
  user          User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  type          NotificationType
  networkId     String? // Reference to Network record if applicable
  activityLogId String? // Reference to ActivityLog if applicable
  activityLog   ActivityLog?     @relation(fields: [activityLogId], references: [id], onDelete: SetNull)
  read          Boolean          @default(false)
  createdAt     DateTime         @default(now())

  @@index([userId, read])
  @@index([userId, createdAt])
  @@map("notifications")
}

enum ActivityType {
  USER_REGISTERED
  USER_LEVEL_UP
  WORKOUT_CREATED
  WORKOUT_SCHEDULED
  SESSION_STARTED
  SESSION_COMPLETED
  NETWORK_CONNECTED
  PROGRAM_STARTED
  PROGRAM_COMPLETED
  STATS_IMPROVED
  LEADERBOARD_ENTRY
}

model ActivityLog {
  id         String       @id @default(cuid())
  userId     String?
  user       User?        @relation(fields: [userId], references: [id], onDelete: SetNull)
  type       ActivityType
  entityType String? // e.g., 'workout', 'session', 'program'
  entityId   String? // ID of the related entity
  message    String // Human-readable message
  metadata   Json? // Additional data (workout name, stats, etc.)
  createdAt  DateTime     @default(now())

  notifications Notification[]

  @@index([userId, createdAt])
  @@index([type, createdAt])
  @@index([createdAt])
  @@map("activity_logs")
}

// Achievement System
enum AchievementCategory {
  STREAK
  VOLUME
  CONSISTENCY
  INTENSITY
  MILESTONE
  SPECIAL
  CONTRIBUTION
}

model Achievement {
  id          String              @id @default(cuid())
  code        String              @unique // e.g., "STREAK_7", "FIRST_WORKOUT"
  name        String
  description String
  category    AchievementCategory
  icon        String // Icon identifier
  rarity      String              @default("COMMON") // COMMON, RARE, EPIC, LEGENDARY
  xpReward    Int                 @default(0)
  metadata    Json? // Additional data (thresholds, conditions, etc.)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt

  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(cuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  earnedAt      DateTime    @default(now())
  metadata      Json? // Additional data (value when earned, etc.)

  @@unique([userId, achievementId])
  @@index([userId, earnedAt])
  @@map("user_achievements")
}
